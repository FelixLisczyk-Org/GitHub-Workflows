name: Xcode Update Swift Package Dependencies
description: Xcode Update Swift Package Dependencies
inputs:
  github-token:
    description: "GitHub Access Token"
  platform:
    description: "Target Build Platform"
  scheme:
    description: "Xcode Scheme Name"
  retry_failed_tests:
    description: "Retry Failed Tests"
    required: false
    default: "false"
  skip_tests:
    description: "Skip Running Tests"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Generate Xcode Project
      run: |
        if [ -f project.yml ]; then
          xcodegen
        elif [ -f Tuist.swift ]; then
          tuist install && tuist cache && tuist generate --no-open
        fi
      shell: bash -leo pipefail {0}
    - name: Update Swift Package Dependencies
      run: swift package update
      shell: bash -leo pipefail {0}
    - name: Update Host App Dependencies
      run: |
        if [ -f project.yml ]; then
          ${{ github.action_path }}/../shared-scripts/clear-xcode-cache.sh
          xcodebuild -resolvePackageDependencies
        elif [ -f Tuist.swift ]; then
          tuist install --update
        fi
      shell: bash -leo pipefail {0}
    - name: Run Unit Tests
      uses: FelixLisczyk-Org/GitHub-Workflows/xcode-test-package@main
      with:
        platform: ${{ inputs.platform }}
        scheme: ${{ inputs.scheme }}
        retry_failed_tests: ${{ inputs.retry_failed_tests }}
      if: ${{ !inputs.skip_tests }}
    - name: Commit & Push changes
      uses: actions-js/push@master
      with:
        github_token: ${{ inputs.github-token }}
        message: Updated dependencies [skip ci]
